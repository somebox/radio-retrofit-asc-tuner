# ============================================
# CONFIGURATION - Update these values for your setup
# ============================================
# IMPORTANT: Update the Music Assistant config entry ID
#
# To find your Music Assistant config entry ID:
#   Settings → Devices & Services → Music Assistant
#   → Click (⋮) three dots → Download Diagnostics
#   → Open the JSON file and find "entry_id"
alias: Radio - Load All Favorites
description: Fetch radios and playlists from Music Assistant for unified browsing
triggers:
  - event: start
    trigger: homeassistant
  - event_type: esphome.retro_radio_sync_favorites
    trigger: event
conditions: []
actions:
  - action: music_assistant.get_library
    data:
      config_entry_id: "{{ music_assistant_config_id }}"
      media_type: radio
      favorite: true
      limit: 100
      order_by: name
    response_variable: radios
  - action: music_assistant.get_library
    data:
      config_entry_id: "{{ music_assistant_config_id }}"
      media_type: playlist
      favorite: true
      limit: 100
      order_by: name
    response_variable: playlists
  - action: esphome.retro_radio_load_all_favorites
    data:
      favorites_json: >
        {%- set ns = namespace(items=[]) -%}
        {%- if radios is defined -%}
          {%- set radio_items = radios['items'] | default([]) -%}
          {%- for radio in radio_items -%}
            {%- if radio.name is defined and radio.uri is defined -%}
              {%- set ns.items = ns.items + [{'name': radio.name, 'uri': radio.uri}] -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
        {%- if playlists is defined -%}
          {%- set playlist_items = playlists['items'] | default([]) -%}
          {%- for playlist in playlist_items -%}
            {%- if playlist.name is defined and playlist.uri is defined -%}
              {%- set ns.items = ns.items + [{'name': playlist.name, 'uri': playlist.uri}] -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
        {{ ns.items | tojson }}
variables:
  music_assistant_config_id: 01K65E8GMGHZXQTFAH6ZJ7TDGY
mode: restart
